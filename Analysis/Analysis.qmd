---
title: "A study on brain metastases from primary breast cancer"
author: "Alberto Fabbri"
format: html
---

## Set up the environment

### Packages

This analysis uses `renv` to manage the dependencies. `renv` is a normal R package that can be installed with:

`install.packages("renv")`

Once `renv` is installed it can be used to install the necessary packages by running the following code:

`renv::restore()`

`renv` will then proceed to install all the packages specified in the `renv.lock` file.

### Quarto

To run this file it is necessary to have `quarto` installed. `quarto` is a software used to create reproducible documents that embed code. It can be installed by downloading it from the official website:

[https://quarto.org]

::: {.content-hidden}
### Load the necessary packages
:::

```{r}
#| label: setup
#| include: false

# Work with single cell and spatial omics data
library("Seurat")
# Replace this future symbols with others because they conflict with the zeallot package
library (future, exclude = c("%->%", "%<-%"));
`%<--%` = future::`%<-%` ;
`%-->%` = future::`%->%` ;
options(future.globals.maxSize = 1000 * 1024^2)
# Parallelize the computation with several worker processes that will run in their own R session
plan("multisession", workers = 6)
# Unpack multiple values without temporary variables
library("zeallot")
# Sane way to declare file paths
library("here")
# Machine learning library from NanoString
library("InSituType")
# Used for the barplots
library("dittoSeq")
# Used to visualize the raw images from AtoMx
library("EBImage")
# Used to annotate images with multiple plots
library("patchwork")
# Used to arrange plots in a common grid
library("ggpubr")

###### TIDYVERSE ######
# Data manipulation
library("dplyr")
# Create nice plots
library("ggplot2")
# Open Excel files
library("readxl")
# Open CSV files
library("readr")
# Better dataframes
library("tibble")
# Pivot tibbles
library("tidyr")

# Prefer dplyr in case of conflict
library("conflicted")
conflict_prefer_all("dplyr")

# Import utility functions
source("Utils.R")

# Import environment variables as global variables
rds_dir <- Sys.getenv("RDS_DIR")
image_dir <- Sys.getenv("IMAGE_DIR")
image_ext <- Sys.getenv("IMAGE_EXT")
```

## General overview of the data

Create a table with an entry for every FOV in the Seurat object analyzed in this study. The table will contain the patient ID, the serial core, the stamp, and the FOV.

```{r}
#| label: data-overview
#| echo: false

# Cohort of all the patients
breast_cancer_patients <- readRDS(here(rds_dir, "breast_cancer_patients.rds"))
immunofluorescence <- breast_cancer_patients@meta.data %>% 
                      dplyr::select("Mean.PanCK", "Mean.CD45", "Mean.CD68")
cohort <- fastCohorting(immunofluorescence,
  gaussian_transform = TRUE, n_cohorts = 5
)
# check clusters and cohort numbers
table(cohort)

# List of the gene data (1000-plex RNA)
rownames(breast_cancer_patients)
# Create a data frame to store the table
patient_table <- data.frame(
  Patient_ID = character(),
  Serial_Cores = character(),
  Stamps = character(),
  FOVs = character(),
  stringsAsFactors = FALSE
)

# Iterate over each patient
for (patient_id in sort(unique(unlist(breast_cancer_patients$Patient.ID)))) {
  # Subset the data for the current patient
  patient_data <- subset(x = breast_cancer_patients@meta.data, subset = Patient.ID == patient_id)

  # Get the unique serial cores for the current patient
  serial_cores <- unique(patient_data$core_serial)

  # Iterate over each serial core
  for (serial_core_id in serial_cores) {
    # Subset the data for the current serial core
    serial_core_data <- subset(x = patient_data, subset = core_serial == serial_core_id)

    # Get the unique stamps for the current serial core
    stamps <- unique(serial_core_data$stamp)
    
    # Iterate over each stamp
    for (stamp_id in stamps) {
      # Subset the data for the current stamp
      stamp_data <- subset(x = serial_core_data, subset = stamp == stamp_id)

      # Get the unique FOVs for the current stamp
      fovs <- unique(stamp_data$fov)

      # Add a row to the patient table for each FOV
      for (fov_id in fovs) {
        patient_table <- rbind(patient_table, data.frame(
          Patient_ID = patient_id,
          Serial_Cores = serial_core_id,
          Stamps = stamp_id,
          FOVs = fov_id
        ))
      }
    }
  }
}

# Print the patient table
print(patient_table)
# Print all the patients ID
sort(unique(unlist(breast_cancer_patients$Patient.ID)))

# Print all the FOV
breast_cancer_fovs <- sort(unique(unlist(breast_cancer_patients$fov)))

# Print the number of stamps
length(unique(paste(
  breast_cancer_patients@meta.data$core_serial,
  breast_cancer_patients@meta.data$stamp)))
```

### Tissue micro array

Print the patients' information and create two representation of the TMA: one with the primary diagnosis highlighted and one with the quality of the FOVs with a primary diagnosis of breast cancer highlighted.

```{r}
#| label: TMA-info

# List with plots & dataframe to be saved
TMA_info_to_save <- list()
# List with plots & dataframe to be displayed
TMA_info_to_display <- list()

# Information about the patients involved in the study
patient_info <- read_excel(here("Analysis", "metadata", "updatedPACC_Copy of METBRA_patient_v1_now_updated_dec_2022_GOOD_mar_2024_Lanzing.xlsx"))
TMA_info_to_display[["Patient_info"]] <- patient_info

# FOVs & Core serials
LU001FFP03_FOV <- read_excel(here("Analysis", "metadata", "LU001FFP03_FOV.xlsx"))
# Core serials, Patients' ID & Primary Diagnosis
TMA_METBRA_COSMX <- read_excel(
  path = here("Analysis", "metadata", "TMA_METBRA_COSMX Analysis.xlsx"),
  sheet = "TMA_list")
# FOVs & associated primary diagnosis
FOVs_primary_diagnosis <- left_join(
  x = LU001FFP03_FOV,
  y = TMA_METBRA_COSMX,
  by = c("core_serial" = "Full Serial Number"))
# X, Y & Z FOVs positions
tissue_micro_array <- read_csv(gzfile(
  here("Analysis", "flat_files", "LU001FFP03", "LU001FFP03_fov_positions_file.csv.gz")),
  col_types = cols(
  Slide = col_integer(),
  X_mm = col_double(),
  Y_mm = col_double(),
  Z_mm = col_double(),
  ZOffset_mm = col_double(),
  ROI = col_integer(),
  FOV = col_integer(),
  Order = col_integer(),
  Run_Tissue_name = col_character()))
# FOVs, associated primary diagnosis & X, Y, Z positions
FOVs_prim_diag_pos <- left_join(
  x = tissue_micro_array,
  y = FOVs_primary_diagnosis,
  by = c("FOV" = "fov"))
# FOVs, associated primary diagnosis, X, Y positions & quality
FOVs_prim_diag_pos_qual <- FOVs_prim_diag_pos %>%
  dplyr::mutate(Quality = case_when(
    is.na(`Primary Diagnosis`) ~ NA_character_,
    `Primary Diagnosis` != "breast cancer" ~ NA_character_,
    FOV %in% breast_cancer_fovs ~ "good",
    TRUE ~ "bad"
  ))

# Plots shared parameters
square_size <- 5
square_text_size <- 1.6
title <- "TMA LU001FFP03"

# TMA plot with FOVs positions and associated primary diagnosis
LU001FFP03_TMA_primary_diag <- ggplot(FOVs_prim_diag_pos_qual, aes(x = X_mm, y = Y_mm)) +
  geom_point(aes(color = `Primary Diagnosis`), shape = 15, size = square_size) +
  geom_text(aes(label = FOV), size = square_text_size) +
  coord_equal() +
  labs(title = title,
       color = "Primary diagnosis") +
  scale_color_manual(values = c("breast cancer" = "#00B5EE", "lung cancer" = "#E26EF7"),
                     na.translate = TRUE, 
                     na.value = "grey50",
                     breaks = c("breast cancer", "lung cancer"))
LU001FFP03_TMA_primary_diag_name <- paste0("TMA_LU001FFP03_primary_diagnosis_highlighted")
TMA_info_to_save[[LU001FFP03_TMA_primary_diag_name]] <- LU001FFP03_TMA_primary_diag

# TMA plot with FOVs positions and quality of those with primary diagnosis of breast cancer
LU001FFP03_TMA_breast_cancers_stamps_quality <- ggplot(
  FOVs_prim_diag_pos_qual, aes(x = X_mm, y = Y_mm)) +
  geom_point(aes(color = `Quality`), shape = 15, size = square_size) +
  geom_text(aes(label = FOV), size = square_text_size) +
  coord_equal() +
  labs(title = title,
       color = "Breast cancer\nstamps quality") +
  scale_color_manual(values = c("good" = "#00BB44", "bad" = "#F8766D"),
                     na.translate = TRUE, 
                     na.value = "grey50",
                     breaks = c("good", "bad"))
LU001FFP03_TMA_breast_cancer_stamps_highlighted_name <- 
  paste0("TMA_LU001FFP03_breast_cancer_stamps_quality")
TMA_info_to_save[[LU001FFP03_TMA_breast_cancer_stamps_highlighted_name]] <- 
  LU001FFP03_TMA_breast_cancers_stamps_quality

print(c(TMA_info_to_display, TMA_info_to_save))
```

::: {.content-hidden}
#### Save plots
:::

```{r}
#| label: save-plots-TMA-info
#| include: false
#| echo: false
#| eval: false

save_plots(TMA_info_to_save, here(image_dir), image_ext)
```

### Read Akoya Data

The Akoya data is available in an Excel file, extract the data for the full cores and rename the columns with the name of the cell types.

```{r}
# File path to the Akoya data
file_path <- here(
  "Analysis",
  "Akoya_spatial_multiplex_immune_cell_data",
  "Breast cancer",
  "M1 Breast Full Cores Final + Image",
  "Results_breast_full_cores.xlsx"
)

# Read the file with the Akoya data
# The data is in the second sheet, the first row is skipped (the header is on the second row)
# and the columns with useless data are removed
data <- read_excel(
  file_path,
  sheet = 2,
  skip = 1,
  col_types = c(
    "skip",
    "skip",
    "text",
    "text",
    "skip",
    "numeric",
    "numeric",
    "numeric",
    "numeric",
    "numeric",
    "numeric",
    "numeric"
  )
)

# Create an empty tibble to store the filtered data
# Only the total cell data is kept
akoya_data <- data %>% slice(0)

# Add only the rows with the total cell count to the tibble
for (i in seq(3, nrow(data), by = 3)) {
  row <- data[i, ]
  akoya_data <- add_row(.data = akoya_data,row)
}

# Rename columns to align with the nomenclaure used in the rest of the analysis
akoya_data <- akoya_data %>% rename(
  "Tumor" = "Pan-CK+/CD4-/CD8-/CD20-/CD68-/FOXP3-",
  "T cell CD4" = "Pan-CK-/CD4+/FOXP3-",
  "T cell regulatory" = "Pan-CK-/CD4+/FOXP3+",
  "T cell CD8" = "Pan-CK-/CD8+",
  "B cell" = "Pan-CK-/CD20+",
  "Macrophage" = "Pan-CK-/CD68+"
)

# Merge the two types of T-cells into a single column
# processed_data <- processed_data %>% mutate(
#   "T-cell" = `T-cell CD4` + `T-cell CD8`
# ) %>% select(-`T-cell CD4`, -`T-cell CD8`)

# Created manually from a schematic of the TMA in METBRA PhenoImager Analysis file
map_TMA_row_column_to_core <- tibble(
  `TMA Row` = c("12", "5", "10", "10", "11", "11", "12", "2", "3", "4", "6", "7", "8", "9", "9"),
  `TMA Column` = c("E", "F", "E", "F", "E", "F", "F", "F", "F", "F", "F", "F", "E", "E", "F"),
  core = c("M6", "M4", "M7", "M2", "M7", "M1", "M1", "M6", "M5", "M5", "M4", "M3", "M8", "M8", "M2")
)

# Merge the data data about the cores with the Akoya data and make it the first column
akoya_data <- akoya_data %>%
  left_join(map_TMA_row_column_to_core, by = c("TMA Row", "TMA Column")) %>%
  select(all_of(names(map_TMA_row_column_to_core)), everything())

# Subset the TMA_METBRA_COSMX data frame to only the useful columns
TMA_METBRA_COSMX_subset <- TMA_METBRA_COSMX[, c("Full Serial Number", "Patient ID")]

# Merge the Patient IDs with the Akoya data and make it the first column
akoya_data <- akoya_data %>%
  left_join(TMA_METBRA_COSMX_subset, by = join_by("core" == "Full Serial Number")) %>%
  mutate(`Patient ID` = as.factor(`Patient ID`)) %>%
  select(`Patient ID`, everything()) %>%
  arrange(`core`)

# Remove columns that were only used for merging
akoya_data <- akoya_data %>%
  select(-`TMA Column`, -`TMA Row`)

# Sum the data for each patient
akoya_by_patient <- akoya_data %>%
  select(-core) %>%
  group_by(`Patient ID`) %>%
  summarise(across(where(is.numeric), \(x) sum(x, na.rm = TRUE)))

# Print the tibbles
print(list(akoya_data, akoya_by_patient))
```


## Clustering per patient

Cluster data for every patient and create a Seurat object for each patient. The functions used to cluster the data are defined in the `Utils.R` file.

The individual script of every patient generates a list with all the images and data frames that can be saved and displayed.

```{r}
#| label: merged-data

# Collect all patients' data in a list
patients_rna_data <- list()
```

### Patient 1

```{r}
#| label: analyze-patient-1

# Steps with all the data
patient_1_all_data <- extract_patient_data(breast_cancer_patients, "1")
patient_1_all_data <- analyze_proteins(patient_1_all_data)
patient_1_plots <- generate_proteins_plots(patient_1_all_data, "proteins")

# Red blood cells removed
patient_1_rbc_removed <- remove_clusters(patient_1_all_data, "protein_clusters", c(5))
patient_1_IST_semisup <- run_IST_semisup_extract_data(patient_1_rbc_removed, "Nanostring")
# Add cluster to the metadata
patient_1_rbc_removed$InSituType_semisup_clusters <- patient_1_IST_semisup$clust

# RNA data only
patient_1_data <- extract_patient_rna_data(patient_1_rbc_removed, "Nanostring")
patient_1_data <- normalize_cluster_data(patient_1_data, "RNA")
patient_1_plots <- c(patient_1_plots, generate_umap(patient_1_data, "RNA_clusters", "umap_RNA"))
patient_1_plots <- c(patient_1_plots, generate_dyn_text_heatmap(patient_1_data, "RNA_clusters", "RNA"))

# Annotations
patient_1_data$RNA_clusters_annotated <- case_match(
  patient_1_data$RNA_clusters,
  c("0", "1", "2", "3") ~ "Tumor",
  "4" ~ "Fibroblast",
  "5" ~ "Macrophage",
  "6" ~ "T cell",
  "7" ~ "Fibroblast"
)
# Generate the UMAP with the non-annotated clusters
patient_1_plots <- c(patient_1_plots, generate_umap(patient_1_data, "InSituType_semisup_clusters", "umap_RNA"))
# Generate the heatmap of the non-annotated clusters
patient_1_plots <- c(patient_1_plots, generate_dyn_text_heatmap(patient_1_data, "InSituType_semisup_clusters", "RNA"))
# Colors for the flighpath plot
InSituType_color_lookup_table_1 <- generate_colors_lookup_table(
    patient_1_data,
    "InSituType_semisup_clusters",
    known_clusters_colors)
# Generate the flightpath plot
patient_1_plots <- c(
    patient_1_plots,
    generate_flightpath(patient_1_IST_semisup, InSituType_color_lookup_table_1, "1"))
# Generate the Louvain clustering plots
patient_1_plots <- c(patient_1_plots, generate_rna_plots(patient_1_data, "RNA", "RNA_clusters_annotated"))
# Annotate the InSituType clusters
patient_1_data$InSituType_semisup_clusters_annotated <- case_match(
  patient_1_data$InSituType_semisup_clusters,
  c("a", "b", "c", "d", "e", "f") ~ "Tumor",
  "g" ~ "Endothelial",
  .default = unname(patient_1_data$InSituType_semisup_clusters)
)
# Colors for the InSituType plot
InSituType_color_lookup_table <- generate_colors_lookup_table(patient_1_data, "InSituType_semisup_clusters_annotated", known_clusters_colors)
# Generate the annotated Insitutype plots
patient_1_plots <- c(patient_1_plots, generate_clustering_plots(patient_1_data, "InSituType_semisup_clusters_annotated",
    cluster_assay = "RNA", 
    cluster_reduction = "umap_RNA",
    create_heatmap = FALSE,
    cluster_name = "InSituType Semisupervised Clusters Annotated",
    color_lookup_table = InSituType_color_lookup_table))
patient_1_plots <- c(patient_1_plots, generate_comparison_plots(patient_1_data))

# Cleanup and printing
patients_rna_data[[1]] <- patient_1_data
print(patient_1_plots)
```

::: {.content-hidden}
#### Save plots
:::

```{r}
#| label: save-plots-patient-1
#| include: false
#| echo: false
#| eval: false

save_plots(patient_1_plots, get_patient_dir_img("1"), image_ext)
```

### Patient 2

```{r}
#| label: analyze-patient-2

# Steps with all the data
patient_2_all_data <- extract_patient_data(breast_cancer_patients, "2")
patient_2_all_data <- analyze_proteins(patient_2_all_data)
patient_2_plots <- generate_proteins_plots(patient_2_all_data, "proteins")

# Red blood cells removed
patient_2_rbc_removed <- remove_clusters(patient_2_all_data, "protein_clusters", c(6))
patient_2_IST_semisup <- run_IST_semisup_extract_data(patient_2_rbc_removed, "Nanostring")
# Add cluster to the metadata
patient_2_rbc_removed$InSituType_semisup_clusters <- patient_2_IST_semisup$clust

# RNA data only
patient_2_data <- extract_patient_rna_data(patient_2_rbc_removed, "Nanostring")
patient_2_data <- normalize_cluster_data(patient_2_data, "RNA")

# Annotations
patient_2_data$RNA_clusters_annotated <- case_match(
  patient_2_data$RNA_clusters,
  c("0", "1", "2") ~ "Tumor",
  "3" ~ "Fibroblast",
  "4" ~ "Macrophage",
  "5" ~ "Endothelial",
  "6" ~ "T cell"
)
patient_2_data$InSituType_semisup_clusters_annotated <- case_match(
  patient_2_data$InSituType_semisup_clusters,
  c("a", "b") ~ "Tumor",
  "c" ~ "Dendritic cell",
  c("d", "e") ~ "Fibroblast",
  .default = unname(patient_2_data$InSituType_semisup_clusters)
)

# Generate plots
patient_2_plots <- c(patient_2_plots, generate_rna_plots(patient_2_data, "RNA", "RNA_clusters_annotated"))
patient_2_plots <- c(patient_2_plots, generate_IST_plots(patient_2_data, "RNA", patient_2_IST_semisup))
patient_2_plots <- c(patient_2_plots, generate_comparison_plots(patient_2_data))

# Cleanup and printing
patients_rna_data[[2]] <- patient_2_data
print(patient_2_plots)
```

::: {.content-hidden}
#### Save plots
:::

```{r}
#| label: save-plots-patient-2
#| include: false
#| echo: false
#| eval: false

save_plots(patient_2_plots, get_patient_dir_img("2"), image_ext)
```

### Patient 3

```{r}
#| label: analyze-patient-3

# Steps with all the data
patient_3_all_data <- extract_patient_data(breast_cancer_patients, "3")
patient_3_all_data <- analyze_proteins(patient_3_all_data)
patient_3_plots <- generate_proteins_plots(patient_3_all_data, "proteins")
patient_3_IST_semisup <- run_IST_semisup_extract_data(patient_3_all_data, "Nanostring")
# Add cluster to the metadata
patient_3_all_data$InSituType_semisup_clusters <- patient_3_IST_semisup$clust

# RNA data only
patient_3_data <- extract_patient_rna_data(patient_3_all_data, "Nanostring")
patient_3_data <- normalize_cluster_data(patient_3_data, "RNA")

# Annotations
patient_3_data$RNA_clusters_annotated <- case_match(
  patient_3_data$RNA_clusters,
  c("0", "2", "3") ~ "Tumor",
  "1" ~ "Macrophage",
  c("4", "7") ~ "Fibroblast",
  "5" ~ "Fibroblast",
  "6" ~ "Endothelial"
)
patient_3_data$InSituType_semisup_clusters_annotated <- case_match(
  patient_3_data$InSituType_semisup_clusters,
  c("a", "c", "d", "e", "g") ~ "Tumor",
  c("b", "f") ~ "Fibroblast",
  .default = unname(patient_3_data$InSituType_semisup_clusters)
)
# Generate plots
patient_3_plots <- c(patient_3_plots, generate_rna_plots(patient_3_data, "RNA", "RNA_clusters_annotated"))
patient_3_plots <- c(patient_3_plots, generate_IST_plots(patient_3_data, "RNA", patient_3_IST_semisup))
patient_3_plots <- c(patient_3_plots, generate_comparison_plots(patient_3_data))

# Cleanup and printing
patients_rna_data[[3]] <- patient_3_data
print(patient_3_plots)
```

::: {.content-hidden}
#### Save plots
:::

```{r}
#| label: save-plots-patient-3
#| include: false
#| echo: false
#| eval: false

save_plots(patient_3_plots, get_patient_dir_img("3"), image_ext)
```

### Patient 4

```{r}
#| label: analyze-patient-4

# Steps with all the data
patient_4_all_data <- extract_patient_data(breast_cancer_patients, "4")
patient_4_all_data <- analyze_proteins(patient_4_all_data)
patient_4_plots <- generate_proteins_plots(patient_4_all_data, "proteins")

# Red blood cells removed
patient_4_rbc_removed <- remove_clusters(patient_4_all_data, "protein_clusters", c(3))
patient_4_IST_semisup <- run_IST_semisup_extract_data(patient_4_rbc_removed, "Nanostring")
# Add cluster to the metadata
patient_4_rbc_removed$InSituType_semisup_clusters <- patient_4_IST_semisup$clust

# RNA data only
patient_4_data <- extract_patient_rna_data(patient_4_rbc_removed, "Nanostring")
patient_4_data <- normalize_cluster_data(patient_4_data, "RNA")

# Annotations
patient_4_data$RNA_clusters_annotated <- case_match(
  patient_4_data$RNA_clusters,
  c("0", "1", "2", "3") ~ "Tumor",
  "4" ~ "Fibroblast",
  "5" ~ "Macrophage",
  "6" ~ "T cell"
)
patient_4_data$InSituType_semisup_clusters_annotated <- case_match(
  patient_4_data$InSituType_semisup_clusters,
  c("a", "c") ~ "Tumor",
  "b" ~ "Dendritic cell",
  c("d", "e") ~ "Fibroblast",
  .default = unname(patient_4_data$InSituType_semisup_clusters)
)

# Generate plots
patient_4_plots <- c(patient_4_plots, generate_rna_plots(patient_4_data, "RNA", "RNA_clusters_annotated"))
patient_4_plots <- c(patient_4_plots, generate_IST_plots(patient_4_data, "RNA", patient_4_IST_semisup))
patient_4_plots <- c(patient_4_plots, generate_comparison_plots(patient_4_data))

# Cleanup and printing
patients_rna_data[[4]] <- patient_4_data
print(patient_4_plots)
```

::: {.content-hidden}
#### Save plots
:::

```{r}
#| label: save-plots-patient-4
#| include: false
#| echo: false
#| eval: false

save_plots(patient_4_plots, get_patient_dir_img("4"), image_ext)
```

### Patient 5

```{r}
#| label: analyze-patient-5

# Steps with all the data
patient_5_all_data <- extract_patient_data(breast_cancer_patients, "5")
patient_5_all_data <- analyze_proteins(patient_5_all_data)
patient_5_plots <- generate_proteins_plots(patient_5_all_data, "proteins")
patient_5_IST_semisup <- run_IST_semisup_extract_data(patient_5_all_data, "Nanostring")
# Add cluster to the metadata
patient_5_all_data$InSituType_semisup_clusters <- patient_5_IST_semisup$clust

# RNA data only
patient_5_data <- extract_patient_rna_data(patient_5_all_data, "Nanostring")
patient_5_data <- normalize_cluster_data(patient_5_data, "RNA")

# Annotations
patient_5_data$RNA_clusters_annotated <- case_match(
  patient_5_data$RNA_clusters,
  c("0", "1") ~ "Tumor",
  c("2", "5") ~ "Dendritic cell",
  "3" ~ "Fibroblast",
  "4" ~ "Macrophage",
  "6" ~ "Endothelial",
  "7" ~ "T cell",
  "8" ~ "T cell",
)
patient_5_data$InSituType_semisup_clusters_annotated <- case_match(
  patient_5_data$InSituType_semisup_clusters,
  c("a", "c", "d", "g") ~ "Tumor",
  c("b", "e") ~ "T cell",
  "f" ~ "Fibroblast",
  .default = unname(patient_5_data$InSituType_semisup_clusters)
)

# Generate plots
patient_5_plots <- c(patient_5_plots, generate_rna_plots(patient_5_data, "RNA", "RNA_clusters_annotated"))
patient_5_plots <- c(patient_5_plots, generate_IST_plots(patient_5_data, "RNA", patient_5_IST_semisup))
patient_5_plots <- c(patient_5_plots, generate_comparison_plots(patient_5_data))

# Cleanup and printing
patients_rna_data[[5]] <- patient_5_data
print(patient_5_plots)
```

::: {.content-hidden}
#### Save plots
:::

```{r}
#| label: save-plots-patient-5
#| include: false
#| echo: false
#| eval: false

save_plots(patient_5_plots, get_patient_dir_img("5"), image_ext)
```

### Patient 6

```{r}
#| label: analyze-patient-6

# Steps with all the data
patient_6_all_data <- extract_patient_data(breast_cancer_patients, "6")
patient_6_all_data <- analyze_proteins(patient_6_all_data)
patient_6_plots <- generate_proteins_plots(patient_6_all_data, "proteins")
patient_6_IST_semisup <- run_IST_semisup_extract_data(patient_6_all_data, "Nanostring")
# Add cluster to the metadata
patient_6_all_data$InSituType_semisup_clusters <- patient_6_IST_semisup$clust

# RNA data only
patient_6_data <- extract_patient_rna_data(patient_6_all_data, "Nanostring")
patient_6_data <- normalize_cluster_data(patient_6_data, "RNA")

# Annotations
patient_6_data$RNA_clusters_annotated <- case_match(
  patient_6_data$RNA_clusters,
  c("0", "1", "2", "4") ~ "Tumor",
  "3" ~ "Fibroblast",
  "5" ~ "Macrophage",
)
patient_6_data$InSituType_semisup_clusters_annotated <- case_match(
  patient_6_data$InSituType_semisup_clusters,
  c("a", "b", "c", "d") ~ "Tumor",
  .default = unname(patient_6_data$InSituType_semisup_clusters)
)

# Generate plots
patient_6_plots <- c(patient_6_plots, generate_rna_plots(patient_6_data, "RNA", "RNA_clusters_annotated"))
patient_6_plots <- c(patient_6_plots, generate_IST_plots(patient_6_data, "RNA", patient_6_IST_semisup))
patient_6_plots <- c(patient_6_plots, generate_comparison_plots(patient_6_data))

# Cleanup and printing
patients_rna_data[[6]] <- patient_6_data
print(patient_6_plots)
```

::: {.content-hidden}
#### Save plots
:::

```{r}
#| label: save-plots-patient-6
#| include: false
#| echo: false
#| eval: false

save_plots(patient_6_plots, get_patient_dir_img("6"), image_ext)
```

### Patient 7

```{r}
#| label: analyze-patient-7

# Steps with all the data
patient_7_all_data <- extract_patient_data(breast_cancer_patients, "7")
patient_7_all_data <- analyze_proteins(patient_7_all_data)
patient_7_plots <- generate_proteins_plots(patient_7_all_data, "proteins")

# Red blood cells removed
patient_7_rbc_removed <- remove_clusters(patient_7_all_data, "protein_clusters", c(7))
patient_7_IST_semisup <- run_IST_semisup_extract_data(patient_7_rbc_removed, "Nanostring")
# Add cluster to the metadata
patient_7_rbc_removed$InSituType_semisup_clusters <- patient_7_IST_semisup$clust

# RNA data only
patient_7_data <- extract_patient_rna_data(patient_7_rbc_removed, "Nanostring")
patient_7_data <- normalize_cluster_data(patient_7_data, "RNA")

# Annotations
patient_7_data$RNA_clusters_annotated <- case_match(
  patient_7_data$RNA_clusters,
  c("0", "1", "2", "3") ~ "Tumor",
  "4" ~ "T cell",
  "5" ~ "Macrophage",
  "6" ~ "Macrophage",
  "7" ~ "Fibroblast",
  "8" ~ "Fibroblast"
)
patient_7_data$InSituType_semisup_clusters_annotated <- case_match(
  patient_7_data$InSituType_semisup_clusters,
  c("a", "b", "c", "d") ~ "Tumor",
  "e" ~ "T cell",
  .default = unname(patient_7_data$InSituType_semisup_clusters)
)

# Generate plots
patient_7_plots <- c(patient_7_plots, generate_rna_plots(patient_7_data, "RNA", "RNA_clusters_annotated"))
patient_7_plots <- c(patient_7_plots, generate_IST_plots(patient_7_data, "RNA", patient_7_IST_semisup))
patient_7_plots <- c(patient_7_plots, generate_comparison_plots(patient_7_data))

# Cleanup and printing
patients_rna_data[[7]] <- patient_7_data
print(patient_7_plots)
```

::: {.content-hidden}
#### Save plots
:::

```{r}
#| label: save-plots-patient-7
#| include: false
#| echo: false
#| eval: false

save_plots(patient_7_plots, get_patient_dir_img("7"), image_ext)
```

## Comparing patients

Compare the patients by plotting the proportion of cells according to the InSituType and Louvain clustering. The data from the Akoya platform is also used as a benchmark.

```{r}
#| label: compare-patients

# Save plots comparing patients in this subfolder
compare_patients_subfolder <- here(image_dir, "Compare_patients")
compare_patients_to_save <- list()

# Create folder for the plots id it does not exist
if (!dir.exists(compare_patients_subfolder)) {
  dir.create(compare_patients_subfolder, recursive = TRUE)
}

# Merge all the Seurat objects together
combined_patients <- patients_rna_data[[1]]
combined_patients <- RenameCells(combined_patients, add.cell.id = "Patient_1")
for (i in 2:length(patients_rna_data)) {
  # Provide a unique identifier for each object
  seurat_obj <- RenameCells(patients_rna_data[[i]], add.cell.id = paste0("Patient_", i))
  combined_patients <- merge(combined_patients, y = seurat_obj, merge.data = TRUE)
}

# Function to extract only the counts and metadata from a Seurat object
seurat_only_counts_and_metadata <- function(seurat_obj) {
  seurat_obj_metadata <- seurat_obj@meta.data
  seurat_obj_project <- seurat_obj@project.name
  export = CreateSeuratObject(counts = LayerData(seurat_obj, assay = "RNA", layer = "counts"), project = seurat_obj_project, meta.data = seurat_obj_metadata)
}

# Apply the function to the list of patients Seurat objects
patients_rna_data_cleaned <- lapply(patients_rna_data, seurat_only_counts_and_metadata)

# Merge the Seurat objects without the red blood cells
breast_cancer_patients_without_rbc <- merge(
  x = patients_rna_data_cleaned[[1]],
  y = patients_rna_data_cleaned[c(2:7)],
  collapse = FALSE,
  merge.data = FALSE,
  merge.dr = FALSE,
  project = "Breast cancer patients without RBC")
# Join the layers to have a single count layer
breast_cancer_patients_without_rbc[["RNA"]] <- JoinLayers(breast_cancer_patients_without_rbc[["RNA"]])

# Create a list of all the cells that are not red blood cells
rbc_filtered_out <- colnames(breast_cancer_patients_without_rbc)
# Save the list of cells that are not red blood cells
write.table(
  rbc_filtered_out,
  file = here("Analysis", "metadata", "rbc_filtered_out.csv"),
  row.names = FALSE,
  col.names = c("Cell.ID"),
  quote = TRUE,
  sep = ",")

patient_id_label <- "Patient ID"
per_cells_label <- "Percent of cells"
cell_types_label <- "Cell Types"

barplot_IST_ss_var = "InSituType_semisup_clusters_annotated"
barplot_IST_ss_color_lookup_table <- generate_colors_lookup_table(combined_patients, barplot_IST_ss_var, known_clusters_colors)
# Plot a barplot comparing the InSituTypeID clusters of all patients
IST_ss_clusters_all_patients <- dittoBarPlot(
    object = combined_patients,
    var = barplot_IST_ss_var,
    group.by = "Patient.ID",
    color.panel = barplot_IST_ss_color_lookup_table) + 
  labs(title = "Proportion of cells according to InSituType clustering",
       x = patient_id_label,
       y = per_cells_label,
       fill = cell_types_label) +
  scale_fill_manual(values = barplot_IST_ss_color_lookup_table) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  guides(fill = guide_legend(ncol = 2, byrow = TRUE))
compare_patients_to_save[["InSituType_annotated_clusters_all_patients_barplot"]] <- IST_ss_clusters_all_patients

# Access the metadata from your Seurat object
metadata <- combined_patients@meta.data

# Calculate the percentages of each cell type per patient
cell_type_percentage <- metadata %>%
  group_by(Patient.ID, InSituType_semisup_clusters_annotated) %>%
  summarise(CellCount = n()) %>%
  mutate(Percentage = (CellCount / sum(CellCount)) * 100) %>%
  ungroup()

# Create a new dataframe to write to Excel
cell_type_percentage_df <- as.data.frame(cell_type_percentage)
library(openxlsx)
# Write the result to an Excel file
write.xlsx(cell_type_percentage_df, file = "Insitutype_cell_type_percentages_per_patient.xlsx")

# Plot a barplot comparing the RNA clusters of all patients
barplot_RNA_ann_var = "RNA_clusters_annotated"
barplot_RNA_ann_color_lookup_table <- generate_colors_lookup_table(combined_patients, barplot_RNA_ann_var, known_clusters_colors)
RNA_ann_clusters_all_patients <- dittoBarPlot(
    object = combined_patients,
    var = barplot_RNA_ann_var,
    group.by = "Patient.ID",
    color.panel = barplot_RNA_ann_color_lookup_table) +
  labs(title = "Proportion of cells according to Louvain clustering",
       x = patient_id_label,
       y = per_cells_label,
       fill = cell_types_label) +
  scale_fill_manual(values = barplot_RNA_ann_color_lookup_table) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  guides(fill = guide_legend(byrow = TRUE))
compare_patients_to_save[["RNA_annotated_clusters_all_patients_barplot"]] <- RNA_ann_clusters_all_patients

# Pivot the table to print it with ggplot
akoya_by_patient_long <- akoya_by_patient %>%
  mutate(`T cell` = `T cell CD4` + `T cell CD8` + `T cell regulatory`) %>%
  select(-`T cell CD4`, -`T cell CD8`, -`T cell regulatory`) %>%
  mutate(`Unknown` = `Total Cells` - rowSums(select(., -`Patient ID`, -`Total Cells`))) %>%
  pivot_longer(cols = -c(`Patient ID`, `Total Cells`), 
               names_to = "Cells Type", 
               values_to = "Cells Quantity")

# Calculate the proportion of each value relative to "Total cells"
akoya_by_patient_long <- akoya_by_patient_long %>%
  mutate(`Cell Quantity Proportion` = `Cells Quantity` / `Total Cells`)

barplot_akoya_color_lookup_table <- generate_colors_lookup_table(akoya_by_patient_long, "Cells Type", known_clusters_colors)
akoya_all_patients <- ggplot(akoya_by_patient_long,
                             aes(x = `Patient ID`, y = `Cell Quantity Proportion`, fill = `Cells Type`)) +
  geom_bar(stat = "identity") +
  labs(title = "Proportion of cells according to Akoya data",
       x = patient_id_label,
       y = per_cells_label,
       fill = cell_types_label) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_manual(values = barplot_akoya_color_lookup_table)
compare_patients_to_save[["Akoya_all_patients_barplot"]] <- akoya_all_patients

# Extract and reshape data for InSituType clustering
IST_ss_clusters_data <- as.data.frame(table(combined_patients$Patient.ID, combined_patients$InSituType_semisup_clusters_annotated))
colnames(IST_ss_clusters_data) <- c("Patient ID", "Cells Type", "Cells Quantity")
cell_types_to_sum <- c("T cell", "T cell CD4", "T cell CD8", "T cell regulatory")

IST_ss_T_cells_data <- IST_ss_clusters_data %>%
  group_by(`Patient ID`) %>%
  summarise(
    `Cells Quantity` = sum(`Cells Quantity`[`Cells Type` %in% cell_types_to_sum]),
    `Cells Type` = "T cell"
  )

IST_ss_clusters_data <- IST_ss_clusters_data %>%
  filter(!`Cells Type` %in% cell_types_to_sum) %>%
  bind_rows(IST_ss_T_cells_data) %>%
  complete(`Patient ID`, `Cells Type`, fill = list(`Cells Quantity` = 0)) %>%
  group_by(`Patient ID`) %>%
  mutate(`Total Cells` = sum(`Cells Quantity`)) %>%
  ungroup() %>%
  mutate(`Cell Quantity Proportion` = `Cells Quantity` / `Total Cells`) %>%
  mutate(`Method` = "InSituType")

# Extract and reshape data for Louvain clustering
RNA_ann_clusters_data <- as.data.frame(table(combined_patients$Patient.ID, combined_patients$RNA_clusters_annotated))
colnames(RNA_ann_clusters_data) <- c("Patient ID", "Cells Type", "Cells Quantity")
# Create a data frame with all Patient IDs and the missing cell type "B cell"
b_cell_data <- RNA_ann_clusters_data %>%
  distinct(`Patient ID`) %>%
  mutate(`Cells Type` = "B cell", `Cells Quantity` = 0)
RNA_ann_clusters_data <- RNA_ann_clusters_data %>%
  bind_rows(b_cell_data) %>%
  complete(`Patient ID`, `Cells Type`, fill = list(`Cells Quantity` = 0)) %>%
  group_by(`Patient ID`) %>%
  mutate(`Total Cells` = sum(`Cells Quantity`)) %>%
  ungroup() %>%
  mutate(`Cell Quantity Proportion` = `Cells Quantity` / `Total Cells`) %>%
  mutate(`Method` = "Louvain")

# Add Method column to Akoya data
akoya_by_patient_long$Method <- "Akoya"

# Combine all data into one data frame
combined_data <- IST_ss_clusters_data %>% full_join(RNA_ann_clusters_data) %>% full_join(akoya_by_patient_long)

combined_barplot_color_lookup_table <- generate_colors_lookup_table(combined_data, "Cells Type", known_clusters_colors)

# Define the order of cell types
cell_type_order <- c("Unknown", "Mast cell", "Plasma", "Plasmablast", "Neutrophil", "NK cell", "Monocyte", "Plasmacytoid dendritic cell", "Dendritic cell", "Endothelial", "Fibroblast", "B cell", "Macrophage", "T cell", "Tumor")
  # Replace with actual cell types in desired order

# Reorder the factor levels in the combined_data dataframe
combined_data$`Cells Type` <- factor(combined_data$`Cells Type`, levels = cell_type_order)

# Plot with all clustering methods and all patients stacked by clustering method
combined_stacked_barplot <- ggplot(
  combined_data,
  aes(x = `Patient ID`, 
      y = `Cell Quantity Proportion`, 
      fill = `Cells Type`)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(rows = vars(`Method`), switch = "x") +
  labs(title = "Proportion of cells according to different clustering methods",
       x = patient_id_label,
       y = per_cells_label,
       fill = cell_types_label) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_manual(values = combined_barplot_color_lookup_table) +
  guides(fill = guide_legend(ncol = 2, byrow = TRUE))
# Save to compare_patients_to_save
compare_patients_to_save[["All_clustering_methods_all_patients_stacked_barplot"]] <- combined_stacked_barplot

# Plot with all clustering methods and all patients grouped by patient
combined_grouped_barplot <- ggplot(combined_data,aes(x = `Method`, 
                               y = `Cell Quantity Proportion`, 
                               fill = `Cells Type`)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Proportion of cells according to different clustering methods",
       x = patient_id_label,
       y = per_cells_label,
       fill = cell_types_label) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_manual(values = combined_barplot_color_lookup_table) +
  guides(fill = guide_legend(ncol = 2, byrow = TRUE)) +
  facet_grid(~ `Patient ID`) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 5))
compare_patients_to_save[["All_clustering_methods_all_patients_grouped_barplot"]] <- combined_grouped_barplot

library("PairedData")

# Filter the combined_data_filtered to keep only the four patients
combined_data_filtered <- combined_data %>%
  filter(`Cells Type` %in% c("T cell", "Tumor", "Macrophage", "B cell"))

# Create all combinations of two methods
method_pairs <- combn(unique(combined_data_filtered$Method), 2, simplify = FALSE)

# Get unique cell types
cell_types <- unique(combined_data_filtered$`Cells Type`)

# Pre-calculate y-axis limits for each Cell Type
y_limits <- combined_data_filtered %>%
  group_by(`Cells Type`) %>%
  summarise(
    ymin = min(`Cell Quantity Proportion`, na.rm = TRUE),
    ymax = max(`Cell Quantity Proportion`, na.rm = TRUE)
  ) %>%
  # Create a named list where the key is the `Cells Type` and the value is c(ymin, ymax)
  rowwise() %>%
  mutate(limits = list(c(ymin, ymax))) %>%
  select(`Cells Type`, limits) %>%
  deframe()

# Create the scatterplot for each combination of cell type and method pair
# Define a fixed set of shapes (adjust as needed)
fixed_shapes <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)  # Up to 10 unique shapes

# Create a mapping from Patient ID to shape
patient_shape_mapping <- setNames(fixed_shapes[1:length(unique(combined_data_filtered$`Patient ID`))], 
                                  unique(combined_data_filtered$`Patient ID`))

plot_list <- list()

for (cell_type in cell_types) {
  # Extract the y-axis limits for this cell type
  y_lim <- y_limits[[cell_type]]
  
  for (pair in method_pairs) {
  
    # Determine if the pair is not Insitutype vs Louvain
    if (!all(pair %in% c("InSituType", "Louvain"))) {
      # Use all seven patients for Insitutype vs Louvain
      data_filtered <- combined_data_filtered %>%
        filter(`Patient ID` %in% c("3", "4", "5", "7"))
    } else {
      # Use all patients for the other pairs
      data_filtered <- combined_data_filtered
    }

    data_filtered <- data_filtered %>%
      filter(Method %in% pair, `Cells Type` == cell_type) %>%
      mutate(Method = factor(Method, levels = pair),
             `Patient ID` = factor(`Patient ID`, levels = names(patient_shape_mapping)))
    
    m1_data <- data_filtered %>%
      filter(Method == pair[1]) %>%
      arrange(`Patient ID`) %>%  # Sort by Patient ID
      pull(`Cell Quantity Proportion`)

    m2_data <- data_filtered %>%
      filter(Method == pair[2]) %>%
      arrange(`Patient ID`) %>%  # Sort by Patient ID
      pull(`Cell Quantity Proportion`)

    # Perform Wilcoxon rank-sum test
    wilcox_test <- wilcox.test(m1_data, m2_data, paired = TRUE, alternative = "two.sided")
    
    # Extract the p-value
    p_value <- wilcox_test$p.value
      
    # Create the plot
    p <- data_filtered %>%
      ggplot(aes(x = Method, y = `Cell Quantity Proportion`, shape = `Patient ID`, group = `Patient ID`)) +
      geom_point() +
      geom_line() +
      labs(
        title = paste0(cell_type, ": ", pair[1], " vs ", pair[2]),
        subtitle = paste0("Wilcoxon p-value: ", signif(p_value, digits = 3)), # Add p-value to plot
        x = "Method",
        y = "Cell Proportion"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(size = 9),   # Adjust title size
        plot.subtitle = element_text(size = 9),   # Adjust title size
        axis.title.y = element_text(size = 8),  # Adjust y-axis label size
        axis.title.x = element_text(size = 8),  # Adjust x-axis label size
        axis.text.x = element_text(size = 7),   # Adjust x-axis text size
        axis.text.y = element_text(size = 7)    # Adjust y-axis text size
        #plot.margin = margin(10, 10, 10, 10)        # Add margin around plots
      ) +
      guides(shape = guide_legend(nrow = 1)) +
      scale_shape_manual(values = patient_shape_mapping) + # Use fixed shape mapping
      ylim(y_lim[1], y_lim[2]) # Apply the same y-axis limit for the cell type
    
    # Add the plot to the list
    plot_list[[paste(cell_type, pair[1], pair[2], sep = "_")]] <- p
  }
}
# Combine plots using cowplot's plot_grid
Compare_clustering_methods_wilcoxon <- ggarrange(plotlist = plot_list, ncol = 3, nrow = 4, align = 'hv', common.legend = TRUE, legend="bottom")

compare_patients_to_save[["Compare_clustering_methods_wilcoxon"]] <- Compare_clustering_methods_wilcoxon

print(compare_patients_to_save)
```

::: {.content-hidden}
### Save plots
:::

```{r}
#| label: save-plots-compare-patients
#| include: false
#| echo: false
#| eval: false

save_plots(compare_patients_to_save, compare_patients_subfolder, image_ext)
```
